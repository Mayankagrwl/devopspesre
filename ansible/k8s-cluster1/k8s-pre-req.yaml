- name: Disable Swap since kubernetes cannot work with SWAP enabled
  shell: |
    swapoff -a

- name: Disable SWAP in fstab so that it is not enabled at reboot
  replace:
    path: /etc/fstab
    regexp: '^(\s*)([^#\n]+\s+)(\w+\s)swap(\s+.*)$'
    replace: '#\1\2\3swap\4'

- name: Disable SELinux
  selinux:
    state: disabled

- name: SELinux Disabled in Config
  lineinfile:
    path: /etc/selinux/config
    regexp: '^SELINUX='
    line: SELINUX=disabled

- name: Modprobe
  shell: |
    modprobe br_netfilter

- name: Add Conf for containerd
  blockinfile:
    path: "/etc/sysctl.d/k8s.conf"
    block: |
      net.bridge.bridge-nf-call-iptables = 1
      net.ipv4.ip_forward = 1
      net.bridge.bridge-nf-call-ip6tables = 1

- name: Echo 1 to IPv4
  shell: |
    echo 1 > /proc/sys/net/ipv4/ip_forward

- name: Apply new settings
  shell: |
    sysctl --system

- name: Download Cri-docker bundle to Machine
  get_url:
    url: https://github.com/Mirantis/cri-dockerd/releases/download/v0.3.13/cri-dockerd-0.3.13.amd64.tgz
    dest: "/tmp/cri-dockerd-0.3.13.amd64.tgz"
  tags: download,local

- name: Unarchive bundle
  src: "/tmp/cri-dockerd-0.3.13.amd64.tgz"
  dest: "/tmp"
  #remote_src: yes
  extra_opts:
  - "--strip-components=1"

- name: Copy cri-docker to /usr/local/bin with right user and permissions
  copy:
    src: "/tmp/cri-dockerd"
    dest: "/usr/local/bin/cri-dockerd"
    mode: "0755"
    #remote_src: yes

#- name: Remove Cric-dockerd from /tmp
 # file:
  #  path: "/tmp/cri-dockerd-0.3.13.amd64.tgz"
   # state: absent

#- name: Remove Cric-dockerd from /tmp
 # file:
  #  path: "/tmp/cri-dockerd"
   # state: absent
- name: Download Cri-docker bundle to Machine
  get_url:
    url: "https://raw.githubusercontent.com/Mirantis/cri-dockerd/master/packaging/systemd/{{item}}"
    dest: "/tmp/{{item}}"
  tags: download,local
  loop:
  - cri-docker.service
  - cri-docker.socket

- name: Copy Cri-docker service and socket files to /etc/systemd/system/
  copy:
    src: "{{item}}"
    dest: "/etc/systemd/system/{{item}}"
    owner: root
    group: root
    mode: 0600
  loop:
  - cri-docker.socket
  - cri-docker.service

- name: Reload Systemd
  shell: systemctl daemon-reload

- name: Enable and start cri-dockerd
  service:
    name:"{{item}}"
    state: started
    enabled: yes
  loop:
  - cri-docker.service
  - cri-docker.socket

